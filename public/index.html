<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Open</title>
</head>
<style>
	.div-1 {
		background-color: #EBEBEB;
	}
</style>

<body>
	<h1>OpenTimestamps</h1>

	<p>If you select a file and submit, the file will be timestamped. The ots file will
		be offered to you for download. <br />

		If you also choose the corresponding ots file, the server will verifiy the timestamp of the file.
	</p>

	<h3>Select a file:</h3>

	<input type="file" id="myfile" name="myfile"><br /><br />

	<h3>Select ots file:</h3>

	<input type="file" id="file_ots"><br /><br />

	<h3>Submit:</h3>
	<button onclick="timestamp()">Submit</button>
	<button onclick="clean()">Clean</button><br /><br />

	<h3>Result:</h3>
	<p id="status">N/A</p>

	<script>
		function clean() {
			document.getElementById('myfile').value = "";
			document.getElementById('file_ots').value = "";
		}

		function timestamp() {

			let files = document.getElementById('myfile');
			console.log(files.value);

			// TODO
			//let extension = files.value.split('.').pop();
			//console.log(extension);

			file = files.files[0];
			file_name = file.name;

			let file_ots = document.getElementById('file_ots').files[0];
			console.log("+++");
			console.log(file);
			console.log(file_ots);

			var fr_file = new FileReader();
			var fr_ots = new FileReader();
			var digestBuffer;

			fr_file.addEventListener('loadend', () => {
				(async function() {
					digestBuffer = await digestMessage(fr_file.result);
					console.log("digest of the file: " + digestBuffer);

					const formData = new FormData();
					formData.append('digest', digestBuffer);

					if (typeof file_ots !== "undefined" ||
						file_ots == "") {
						const formData = new FormData();
						formData.append('digest', digestBuffer);
						formData.append('ots', file_ots);

						fetch('verify', {
								method: 'POST',
								body: formData
							}).then(function(response) {
								return response.text();
							})
							.then(function(text) {
								document.getElementById("status").innerHTML = text;
								console.log('Request successful:', text);
							})
							.catch(function(error) {
								console.log('Request failed', error)
							});
						return
					}

					fetch('timestamp', {
							method: 'POST',
							body: formData
						})
						.then(response => {
							console.log(response.status)
							if (response.status != 200) {
								return response.text();
							}
							return response.blob()
						})
						.then(blob => {
							if (typeof(blob) == "string") {
								throw new Error(blob);
							}

							var url = window.URL.createObjectURL(blob);
							var a = document.createElement('a');
							a.href = url;
							a.download = file_name + ".ots";
							document.body.appendChild(a); // we need to append the element to the dom -> otherwise it will not work in firefox
							a.click();
							a.remove(); //afterwards we remove the element again
							document.getElementById("status").innerHTML = "OTS file ready for download.";
						})
						.catch(err => {
							console.log("request failed", err)
							document.getElementById("status").innerHTML = err.message;
						});
				})();
			});

			// read the file first. 
			fr_file.readAsArrayBuffer(file);
		}

		async function digestMessage(message) {
			const hash = await crypto.subtle.digest('SHA-256', message);
			const hashArray = Array.from(new Uint8Array(hash));
			const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
			return hashHex;
		}
	</script>
</body>

</html>